document.write('<!doctype html><meta charset=UTF-8><title>Whiskers Valley</title><link rel="shortcut icon" type=image/x-icon><style>:root{--green0:#e3ecd7;--green1:#6b9a71;--green2:#457a5f;--green3:#244f55;--blue0:#a5d5df;--blue1:#79b4d5;--blue2:#4d80ab;--blue3:#414776;--blue4:#33315d;--blue5:#2b2441;--blue6:#211729;--purple0:#e3c5cf;--purple1:#b79fbb;--purple2:#8e8bb6;--purple3:#5f6791;--purple4:#8d5180;--purple5:#b67388;--yellow0:#fffef9;--yellow1:#efdbb3;--yellow2:#e1ae98;--black:var(--blue6);--white:var(--yellow0)}canvas{height:100%;width:100%;position:absolute;image-rendering:pixelated;object-fit:contain}body,html{margin:0;display:flex;justify-content:center;align-items:center;height:100%;background:var(--black)}#c1{background-size:2px 2px}.nighttime{filter:brightness(.7) contrast(1.6) hue-rotate(40deg);transition:filter 10s}</style><div id=debug style=position:fixed;top:60px;left:0;color:#fff;padding:1vh;font-size:10px;z-index:1><span id=fps></span><span id=coords></span></div><canvas height=540 id=c1 width=960></canvas><canvas height=540 id=c2 width=960></canvas><canvas height=540 id=c3 width=960></canvas><canvas height=540 id=c4 width=960></canvas>');function t(t,s,i=0,h=0){m.push({t,time:s,i:s+h,repeat:i})}function s(t){for(let s=m.length-1;s>=0;s--){const i=m[s];if(!i)return;i.i-=t,i.i>0||(i.t(),i.repeat-- >0?i.i=i.time:m.splice(s,1))}}function i(t,s){for(const i of["x","y"])if(t[i]!==t.h[i]){const h=t.h[i]-t[i],e=Math.sign(h)*t.speed*s/1e3;Math.abs(h)>Math.abs(e)?t[i]+=e:t[i]=t.h[i]}else t.o[i]=0,t[i]=Math.round(t[i])}let h;const e=new class{constructor(){this.l=!1,this.u=!1,this.p=!1,this.m=!1,this.M=!1,this.k=!1,this.v=!1,this.A=!1,this.C=!1,this.S=!1,this.$=new Map,this.I={l:this.l,u:this.u,M:this.M,k:this.k,v:this.v,A:this.A,C:this.C},document.addEventListener("keydown",t=>this.P(t,!0)),document.addEventListener("keyup",t=>this.P(t,!1)),this.B=new DOMPoint}W(){this.I.l=this.l,this.I.u=this.u,this.I.M=this.M,this.I.k=this.k,this.I.v=this.v,this.I.A=this.A,this.I.C=this.C;const t=navigator.getGamepads()[0],s=s=>t?.buttons[s].pressed,i=this.$.get("KeyA")||this.$.get("ArrowLeft")||s(14)?-1:0,h=this.$.get("KeyD")||this.$.get("ArrowRight")||s(15)?1:0,e=this.$.get("KeyW")||this.$.get("ArrowUp")||s(12)?-1:0,o=this.$.get("KeyS")||this.$.get("ArrowDown")||s(13)?1:0;this.B.x=i+h||t?.axes[0]||0,this.B.y=e+o||t?.axes[1]||0,.1>Math.hypot(this.B.x,this.B.y)&&(this.B.x=0,this.B.y=0),this.l=0>this.B.y,this.u=this.B.y>0,this.p=0>this.B.x,this.m=this.B.x>0,this.S=0!==this.B.x||0!==this.B.y,this.M=!!(this.$.get("Enter")||s(0)||s(9)),this.k=!(!this.$.get("Escape")&&!s(8)),this.v=!(!this.$.get("Digit1")&&!s(2)),this.A=!(!this.$.get("Digit2")&&!s(2)),this.C=!(!this.$.get("Digit3")&&!s(2))}P(t,s){this.$.set(t.code,s)}},o=(t,s,i,h)=>128>h?[0,0,0,0]:[51*Math.round(t/51),51*Math.round(s/51),51*Math.round(i/51),255],n=(t,s=10)=>{const i=Math.floor(1.25*s),h=Math.floor(.25*s/2),e=document.createElement("canvas");e.width=i,e.height=i;const n=e.getContext("2d");n.font=s+"px sans-serif",n.textBaseline="top",n.clearRect(0,0,i,i),n.translate(-1,0),n.fillText(t,h,h);const r=n.getImageData(0,0,i,i).data,a=n.createImageData(i,i),c=a.data;for(let t=0;r.length>t;t+=4){const[s,i,h,e]=o(r[t],r[t+1],r[t+2],r[t+3]);c[t]=s,c[t+1]=i,c[t+2]=h,c[t+3]=e}const l=document.createElement("canvas");l.width=i,l.height=i,l.getContext("2d").putImageData(a,0,0);const u=new Image;return u.src=l.toDataURL(),u};class r{constructor(t,s=16,i=[]){this.j=t,this.D=s,this.T=i,this.H={},this.L()}L(){const t=new Image;t.src=this.j,t.onload=()=>{this.F(t)}}F(t){const s=document.createElement("canvas"),i=s.getContext("2d");i&&(s.width=t.width,s.height=t.height,i.drawImage(t,0,0),this.K(i))}K(t){for(let s=0;this.T.length>s;s++){const i=this.T[s],h=[],e=t.canvas.width/this.D;for(let i=0;e>i;i++){const e=t.getImageData(i*this.D,s*this.D,this.D,this.D),o=document.createElement("canvas");o.width=this.D,o.height=this.D;const n=o.getContext("2d");if(n){n.putImageData(e,0,0);const t=new Image;t.src=o.toDataURL(),h.push(t)}}this.H[i]=h}}}const a=new Proxy({},{get(t,s){return"undefined"==typeof window||"undefined"==typeof document?"":getComputedStyle(document.documentElement).getPropertyValue("--"+s).trim()||""}}),c=["sit","idle","walk","run","die","scratch","confused","sleep"],l=["walk","idle","scared"],u=["spruce","oak","house","field","statue","obelisk"];"🔥,🍀,🌼,🐓,🌷,🌹,👻,🥚,🍎".split(",").map(t=>n(t));class d{static initialize(){this.N=new r("cat.png",16,c),this.O=new r("assets.png",16,u),this.U=new r("villager.png",8,l),this.V=((t=a.q)=>{const s=document.createElement("canvas");s.width=16,s.height=16;const i=s.getContext("2d");i.clearRect(0,0,16,16),i.fillStyle=t,i.fillRect(0,0,1,1),i.fillRect(1,0,1,1),i.fillRect(0,1,1,1),i.fillRect(14,0,1,1),i.fillRect(15,0,1,1),i.fillRect(15,1,1,1),i.fillRect(0,14,1,1),i.fillRect(0,15,1,1),i.fillRect(1,15,1,1),i.fillRect(15,14,1,1),i.fillRect(14,15,1,1),i.fillRect(15,15,1,1);const h=new Image;return h.src=s.toDataURL(),h})()}}const f="6v7ic,6trd0,6to3o,6nvic,55eyo,2np50,2jcjo,3ugt8,34ao,7k,glc,1,opzc,3xdeu,3sapz,8rhfz,8ri26,1bzky,9j1ny,3ws2u,9dv9k,3xb1i,3xbmu,2t8g,2t8s,26ndv,ajmo,fl5ug,3x7nm,n75t,54br,59u0e,53if,rlev,4jrb,1yjk4,4eav,55q95,18zsz,mi3r,574tl,1aedd,ljn9,a1bd,4f1i,a1fs,549t,53ig,5832,1dwsh,6iw6,6ix0,cbsa,6gix,6fk4,aky7,7mbws,cvtyq,deehh,".split(","),w={},p=t=>{if("0"===t)return{G:"0".repeat(25),R:0,J:5};const s=(parseInt(t,36).toString(2)+"").padStart(25,"0");let i=5,h=-1;for(let t=0;5>t;t++)for(let e=0;5>e;e++)"1"===s[5*e+t]&&(i=Math.min(i,t),h=Math.max(h,t));return{G:s,R:i,J:i>h?1:h-i+1}},g=(t,s,i,h,e,o=0)=>{for(let n=-e;e>=n;n++){const r=n/e,a=Math.round(h*Math.sqrt(1-r*r));if(a>0){const h=Math.round(o*Math.abs(n));t.rect(0>n?s-a+h:s-a-h,i+n,2*a,1)}}};class x{constructor(){this.Y=0,this.Z=0,this.zoom=1,this.X=0,this._=0,this.tt=1,this.st=.08,this.it=c1.getContext("2d"),this.ht=c2.getContext("2d"),this.et=c3.getContext("2d"),this.ot=c4.getContext("2d"),d.initialize(),this.nt(),window.addEventListener("resize",()=>this.nt()),window.addEventListener("orientationchange",()=>this.nt())}nt(){const t=[this.it,this.ht,this.et,this.ot];for(const s of t)s.canvas.width=1200,s.canvas.height=900,s.imageSmoothingEnabled=!1}get rt(){return this.ht.canvas.width}get ct(){return this.ht.canvas.height}lt(t,s,i,h,e,o,n){t.save(),t.beginPath(),g(t,s,i,h,e),g(t,s,i,h-n,e-n),t.clip("evenodd"),t.beginPath(),t.fillStyle=o,t.fillRect(s-h,i-e,2*h,2*e),t.fill(),t.restore()}ut(t,s){((t,{text:s,color:i=a.dt,textAlign:h="left",textBaseline:e="top",size:o=2,ft:n=1,...r})=>{const c=Math.round(r.x),l=Math.round(r.y);s||(s=" ");const u=n*o,d=s.replace("!","@").toUpperCase().split("");let g=0;const x=[];d.forEach((t,s)=>{const i=(h=" "===t?"0":f[t.charCodeAt(0)-35],p(h).J*o);var h;x.push({char:t,x:g,J:i}),g+=i+(d.length-1>s?u:0)});const y=5*o,m="left"===h?0:"center"===h?Math.round(g/2):g,M="top"===e?0:"middle"===e?Math.round(y/2):y;x.forEach(({char:s,x:h,J:e})=>{if(" "===s)return;const n=((t,s,i)=>{const h=`${t.charCodeAt(0)}-${i}-${s}`;return w[h]||(w[h]=((t,s,i)=>{const h=" "===t?"0":f[t.charCodeAt(0)-35],{G:e,R:o,J:n}=p(h),r=n*s,a=5*s,c=document.createElement("canvas");c.setAttribute("width",""+r),c.setAttribute("height",""+a);const l=c.getContext("2d"),[u,d,w,g]=i.replace(/^#?([a-f\d])([a-f\d])([a-f\d])([a-f\d])$/i,(t,s,i,h,e)=>"#"+s+s+i+i+h+h+e+e).substring(1).match(/.{2}/g).map(t=>parseInt(t,16)),x=`rgba(${u}, ${d}, ${w}, ${(g||255)/255})`;return e.split("").forEach((t,i)=>{if("0"!==t){const t=i%5,h=Math.floor(i/5);if(o>t)return;const e=t-o;l.fillStyle=x,l.fillRect(e*s,h*s,s,s)}}),c})(t,s,i)),w[h]})(s,o,i);t.drawImage(n,0,0,e,y,c-m+h,l-M,e,y)})})(s||this.it,t)}static drawImage(t,s,i,h,e,o,n){e&&(t.save(),t.scale(-1,1),i=-i-(o??s.width)),t.drawImage(s,i,h,o??s.width,n??s.height),e&&t.restore()}wt(t,s,i,h,e,o){x.drawImage(this.it,t,s,i,h,e,o)}gt(t,s,i=1,h=!1){this.X=t,this._=s,this.tt=i,this.it.setTransform(this.zoom,0,0,this.zoom,this.rt/2-32-this.Y*this.zoom,this.ct/2-64-this.Z*this.zoom),h&&(this.Y=t,this.Z=s,this.zoom=i)}xt(){this.Y+=(this.X-this.Y)*this.st,this.Z+=(this._-this.Z)*this.st,this.zoom+=(this.tt-this.zoom)*this.st}yt(){this.it.setTransform(1,0,0,1,0,0)}clear(){this.yt(),this.it.clearRect(0,0,this.rt,this.ct),this.it.fillStyle=a.Mt,this.it.fillRect(0,0,this.rt,this.ct),this.ht.clearRect(0,0,this.rt,this.ct),this.et.clearRect(0,0,this.rt,this.ct)}bt(t,s,i=7){return{x:this.rt/2-32+(t-this.Y)*i,y:this.ct/2-64+(s-this.Z)*i}}}const y=new x;let m=[];const M=11,b=11,k=20,v=[[[69,100,3],[76,113,4],[89,114,5],[104,86,3],[99,59,3],[85,46,2],[86,28,2],[74,38,2],[60,39,2],[48,30,2],[46,43,2],[38,61,3],[50,73,4],[38,84,3],[46,123,3],[36,133,2],[48,141,3],[94,133,4],[113,109,5],[122,74,6],[113,56,.9]],[[45,49,.9],[71,51,.9]],[[91,52,2],[129,29,2]]],z=[{x:64,y:88,r:6},{x:75,y:88,r:6},{x:69,y:95,r:6},{x:129,y:28,r:10},{x:71,y:51,r:3}],A={kt:{x:76,y:84,name:"heart"},vt:{x:129,y:19,name:"moon"},zt:{x:49,y:29,name:"ear"},eye:{x:71,y:50,name:"eye"},At:{x:35,y:131,name:"foot"},Ct:{x:114,y:56,name:"tail"}};class C{constructor(t,s,i,h,e,o=0,n=!1){this.St=t,this.x=s,this.y=i,this.type=h,this.animation=e,this.speed=o,this.$t=n,this.It=0,this.animationDuration=150,this.Pt=!0,this.o={x:0,y:0},this.Bt=Math.ceil(s/M),this.Et=Math.ceil(i/b),this.It=Math.random()*this.animationDuration,this.h={x:this.x,y:this.y}}Wt(t,s){this.Bt=t,this.Et=s,this.x=t*M,this.y=s*b,this.h={x:this.x,y:this.y}}update(t){this.It+=t}jt(t){i(this,t),0!==this.o.x&&(this.$t=0>this.o.x)}draw(){const t=this.St.H[this.animation],s=Math.floor(this.It/this.animationDuration)%t.length;t[s]&&y.wt(t[s],this.x-(this.St.D-M)/2,this.y-(this.St.D-b)/2,this.$t)}}const S=(t,s)=>{document.addEventListener(t,t=>{s(t.detail)})},$=(t,s)=>{console.log("event",t,s),document.dispatchEvent(new CustomEvent(t,{detail:s}))};class I extends C{constructor(s,i,h,e){super(d.N,s*M,i*b,"cat","sleep",80),this.map=h,this.Dt=e,this.type="cat",this.Tt=!0,this.Ht=!1,this.Lt=!1,this.map.Ft={Bt:s+1,Et:i},S("teleport",()=>{this.Wt(A.kt.x,A.kt.y+1)}),S("wake-up",()=>{this.Tt=!1}),S("attack-player",()=>{this.Lt=!0;const s=this.animationDuration;this.animationDuration=s/2,t(()=>{this.animationDuration=s,this.Lt=!1},600)}),S("game-over",()=>{this.animation="die",this.Pt=!1})}update(s){if(super.update(s),coords.innerText=`${this.Bt},${this.Et}`,!this.Dt.Kt)if(this.Lt)this.animation="confused";else if(this.Tt)this.animation="sleep";else if(this.Ht)this.animation="scratch";else{if(super.jt(s),!this.o.y&&e.B.y){const t=this.Et+e.B.y;0>t||t>=this.map.Nt||this.map.grid[t][this.Bt].content||(this.animation="run",this.o.y=e.B.y,this.h.y+=e.B.y*b,this.Et=t),this.map.Ft={Bt:this.Bt,Et:this.Et+e.B.y}}if(!this.o.x&&e.B.x){this.$t=e.p;const t=this.Bt+e.B.x;0>t||t>=this.map.Ot||this.map.grid[this.Et][t].content||(this.animation="run",this.o.x=e.B.x,this.h.x+=e.B.x*M,this.Bt=t),this.map.Ft={Bt:this.Bt+e.B.x,Et:this.Et}}this.o.x||this.o.y||(this.animation="idle"),this.Ht||!e.v||e.I.v||(this.Ht=!0,this.It=0,t(()=>this.Ut(),500),t(()=>{this.Ht=!1},5*this.animationDuration))}}Ut(){const t=this.map.Vt();t.content&&"spirit"===t.content.type&&t.content.qt(1)}}class P extends C{constructor(t,s,i){super(d.O,t,s,i,i),this.x=t,this.y=s,this.Gt={top:!1,bottom:!1,left:!1,right:!1},this.Rt=d.O.H[i][0]}Jt(t){this.Gt=t}draw(){this.Gt.right&&y.wt(this.Rt,Math.round(this.x+5.5),this.y-5.5),y.wt(this.Rt,this.x,this.y)}}class B{constructor(t=45){this.Yt=t}next(){return this.Yt=(9301*this.Yt+49297)%233280,this.Yt/233280}range(t,s){return t+this.next()*(s-t)}}class E extends C{constructor(t,s){super(d.O,t*M,s*b,"house","house"),this.Zt=[]}}class W extends C{constructor(t,s,i,h){super(d.U,t*M,s*b,"villager","idle",10),this.Qt=!0,this.Xt=null,this._t=0,this.ts=1e3,this.ss=!1,this.map=i,this.hs=h}update(t){super.update(t),this._t+=t,this.es()?(this.ss||this.ts>this._t||(this._t=0,this.ss=!0),t>this._t%(this.ts/5)&&($("scared"),this.ns()),this.animation="scared",this.animationDuration=50):(this.ss=!1,this.animationDuration=150,this.ts>this._t||(this.rs(),this._t=0),this.jt(t))}ns(){const t=y.bt(this.x+5.5,this.y),s=y.rt/2,i={from:{x:t.x-10+Math.round(20*Math.random()),y:t.y-50+Math.round(100*Math.random())},to:{x:s,y:30},size:5+Math.round(5*Math.random()),color:a.cs,duration:500};$("particle",i)}rs(){if(this.Qt)return void this.ls();const t=[{x:0,y:-1},{x:0,y:1},{x:1,y:0},{x:-1,y:0}];let s=null;if(this.Xt&&.8>Math.random()&&this.us(this.Bt+this.Xt.x,this.Et+this.Xt.y)&&(s=this.Xt),!s){const i=[...t].sort(()=>Math.random()-.5);for(const t of i)if(this.us(this.Bt+t.x,this.Et+t.y)){s=t;break}}if(s){const t=this.Bt+s.x,i=this.Et+s.y;this.Bt=t,this.Et=i,this.h={x:t*M,y:i*b},this.Xt=s,this.animation="walk"}else this.animation="idle"}ls(){const t={Bt:this.hs.Bt,Et:this.hs.Et+1};this.map.grid[t.Et][t.Bt].content||(this.Qt=!1,this.animation="idle",this.map.grid[t.Et][t.Bt].content=this,this.Wt(t.Bt,t.Et),this.y-=5.5)}us(t,s){return null===this.map.grid[s][t].content}es(){const t=[];for(let s=-1;1>=s;s++)for(let i=-1;1>=i;i++)0===s&&0===i||t.push({Bt:this.Bt+s,Et:this.Et+i});if(this.Xt){const s=this.Bt+this.Xt.x,i=this.Et+this.Xt.y;for(let h=-1;1>=h;h++)for(let e=-1;1>=e;e++)t.push({Bt:s+h,Et:i+e})}for(const{Bt:s,Et:i}of t){if(0>i||i>=this.map.Nt||0>s||s>=this.map.Ot)continue;const t=this.map.grid[i][s];if("cat"===t.content?.type)return!0}return!1}}class j extends C{constructor(t,s){super(d.O,t*M,s*b,"field","field")}}class D{constructor(t,s,i,h,e){this.name=t,this.ds=s,this.radius=i,this.fs=h,this.ws=e,this.ps=[],this.gs=[],this.xs=[],this.ds=s,this.radius=i}update(t){this.ps.forEach(s=>{s.Zt.forEach(s=>{s.Qt&&s.update(t)})})}ys(t){for(let s=0;this.fs>s;s++){let s,i;do{const h=t.range(0,2*Math.PI),e=t.range(1,this.radius-1);s=Math.round(this.ds.x+Math.cos(h)*e),i=Math.round(this.ds.y+Math.sin(h)*e),s+=s%2,i+=i%2}while(0>s||0>i||this.ps.some(t=>t.x===s&&t.y===i));this.ps.push(new E(s,i))}return this.ps}Ms(t){const s=Math.ceil(this.fs/3);for(let i=0;s>i;i++){let s,i;do{const h=t.range(0,2*Math.PI),e=t.range(1,this.radius-1);s=Math.round(this.ds.x+Math.cos(h)*e),i=Math.round(this.ds.y+Math.sin(h)*e)}while(0>s||0>i||this.gs.some(t=>t.x===s&&t.y===i));for(let t=0;2>t;t++)for(let h=0;2>h;h++)this.gs.push(new j(s+t,i+h))}return this.gs}bs(t){const s=this.ws/this.fs;return this.ps.forEach(i=>{for(;s>i.Zt.length;){const s=new W(i.x,i.y,t,i);i.Zt.push(s),this.xs.push(s)}}),this.xs}}class T{constructor(t,s,i,h){this.icon=t,this.Bt=s,this.Et=i,this.type=h,this.x=Math.round(this.Bt*M+(M-this.icon.width)/2),this.y=Math.round(this.Et*b+(b-this.icon.height)/2)}draw(){y.wt(this.icon,this.x,this.y)}}const H=[{x:0,y:-1},{x:0,y:1},{x:1,y:0},{x:-1,y:0}],L=(t,s)=>`${t},${s}`,F=(t,s,i)=>{const h=[];let e=i;for(;e!=s;)h.unshift(e),e=t[L(e.Bt,e.Et)];return h.unshift(s),h},K=[a.ks,a.vs,a.zs,a.q],N=(t,s,i,h,e=K)=>{const o=Math.floor(11*Math.max(0,Math.min(1,t/s))),n=i,r=h-5;y.it.fillStyle=e[0],y.it.fillRect(n,r,o,1),y.it.fillStyle=e[1],y.it.fillRect(n,r+1,o,1),y.it.fillStyle=e[2],y.it.fillRect(n+o,r,11-o,1),y.it.fillStyle=e[3],y.it.fillRect(n+o,r+1,11-o,1)},O=["🎈","🥨","🌵","🧚🏻‍♀️","🦀","👻","👹","🧿","💀"].reduce((t,s,i)=>(t[s]={icon:n(s),type:s,level:Math.ceil(i/2)},t),{});class U extends T{constructor(t,s,i,h){super(O[i].icon,t,s,"spirit"),this.animationDuration=2e3,this.It=0,this.opacity=0,this.As=9,this._t=0,this.ts=600,this.o={x:0,y:0},this.speed=20,this.Cs=!1,this.state="idle",this.Ss=0,this.$s=1e3,this.Is=null,this.Ps=0,this.Bs=0,this.species=O[i],this.map=h,this.h={x:this.x,y:this.y},this.Es=Math.round(Math.pow(1.5,this.species.level+1)),this.Ws=this.Es}update(t){if(this.Ws>0)switch(this.It+=t*Math.pow(this.species.level+.5,2),1>this.opacity&&(this.opacity+=t/this.animationDuration),this.animationDuration>this.It||(this.It-=this.animationDuration),this.state){case"idle":case"moving":i(this,t);const s=this.js();s&&(this._t+=t,this.ts>this._t||(this.Ds(s),this._t=0));break;case"winding":case"attacking":case"resting":this.Ts(t)}}Ts(t){this.Ss+=t;const s=this.Ss/this.$s;if(!this.Is)return void(this.state="idle");const i=this.Is.Bt-this.Bt,h=this.Is.Et-this.Et;if(.7>s){"winding"!==this.state&&(this.state="winding");const t=s/.7;this.Ps=-i*t*3,this.Bs=-h*t*3}else if(.73>s){"attacking"!==this.state&&(this.state="attacking");const t=(s-.7)/.03;this.Ps=i*(M*t-3),this.Bs=h*(M*t-3)}else if(1>s){if("resting"!==this.state){this.state="resting";const t=this.map.grid[this.Is.Et][this.Is.Bt];"cat"===t.content?.type&&$("attack-player",this.species.level)}const t=(s-.73)/.27;this.Ps=3*i*(1-t),this.Bs=3*h*(1-t)}else this.state="idle",this.Ss=0,this.Is=null,this.Ps=0,this.Bs=0}js(){for(let t=-this.As;this.As>=t;t++)for(let s=-this.As;this.As>=s;s++){const i=this.Bt+t,h=this.Et+s;if(i>=0&&this.map.Ot>i&&h>=0&&this.map.Nt>h){const t=this.map.grid[h][i];if("cat"===t.content?.type)return{Bt:i,Et:h}}}return null}Ds(t){const s=((t,s,i,h=100)=>{let e=h;const o=[s],n=new Set,r={};for(;0!==o.length&&e--;){const h=o.shift();if(h.Bt===i.Bt&&h.Et===i.Et)return F(r,s,i);H.map(({x:s,y:i})=>t[h.Et+i][h.Bt+s]).forEach(t=>{n.has(t)||(n.add(t),(null===t.content||t.x==i.Bt&&t.y==i.Et)&&(r[L(t.x,t.y)]=h,o.push({Bt:t.x,Et:t.y})))})}console.log("No path was found")})(this.map.grid,{Bt:this.Bt,Et:this.Et},t);if(s&&s.length>2){this.state="moving";const t=s[1];h=t.Et,(i=this).h.x=t.Bt*M,i.h.y=h*b,this.Bt=t.Bt,this.Et=t.Et,this.h.x=t.Bt*M,this.h.y=t.Et*b}else 2===s?.length&&(this.state="winding",this.Is=s[1],this.Ss=0);var i,h}draw(){const t=Math.sin(this.It/this.animationDuration*2*Math.PI);y.it.save(),y.it.globalAlpha=this.opacity,y.it.fillStyle=`rgba(0,0,0,${Math.round(2+1*t)/10})`,y.it.fillRect(this.x+3+this.Ps,this.y+8.25+this.Bs,this.icon.width-6,3.75),this.Es>this.Ws&&N(this.Ws,this.Es,this.x,this.y),y.it.save(),y.it.translate(this.Ps,this.Bs+Math.round(2*(t-1))),super.draw(),y.it.restore(),y.it.restore()}qt(s=1){return this.Ws-=s,this.Ws>0||t(()=>{this.Cs=!0},2e3),0>=this.Ws}}class V extends C{constructor(t,s,i,h,e){super(d.O,t*M,s*b,"statue","statue"),this.map=i,this.Dt=h,this.name=e,this.Hs=[],this.Ls=9,this.Fs=0,this.Ks=1e3,this.Ns=.1,this.Os=10,this.Us=19,this.state="broken",this.Vs=1500,this.qs=0}update(t){this.Fs+=t,"broken"!==this.state||k>this.Us?"animating"===this.state&&(this.qs+=t,this.qs>this.Vs&&(this.state="repaired")):this.state="animating",this.Ks>this.Fs||(this.Fs=0,this.Ls>this.Hs.length&&Math.random()<this.Ns&&this.Gs()),this.Hs=this.Hs.filter(t=>!t.Cs)}draw(){"animating"===this.state&&this.Rs(),super.draw(),this.Us>0&&N(this.Us,k,this.x,this.y,[a.Js,a.Ys,a.cs,a.Zs])}Rs(){const t=3*this.qs/this.Vs%1;console.log(t);const s=c1.width/y.zoom,i=c1.height/y.zoom;y.lt(y.it,this.x+5.5,this.y+5.5,s*t,i*t,a.dt,8)}Gs(){const t=[];for(let s=-this.Os;this.Os>=s;s++)for(let i=-this.Os;this.Os>=i;i++){const h=this.Bt+s,e=this.Et+i;h>=0&&this.map.Ot>h&&e>=0&&this.map.Nt>e&&null===this.map.grid[e][h].content&&t.push({x:h,y:e})}if(t.length>0){const s=t[Math.floor(Math.random()*t.length)],i=Object.values(O).filter(t=>this.Dt.level>t.level),h=i[Math.floor(Math.random()*i.length)],e=new U(s.x,s.y,h.type,this.map);this.Hs.push(e),this.map.set(s.x,s.y,e)}}}class q{constructor(t,s,i){this.Ot=t,this.Nt=s,this.Dt=i,this.Qs=[],this.Ft={Bt:0,Et:0},this.Xs=new B,this.grid=Array.from({length:s},(s,i)=>Array.from({length:t},(t,s)=>{const h=s-70,e=i-90;let o;o=Math.sqrt(h*h+e*e)>40?.2>this.Xs.next()?"spruce":"oak":.9>this.Xs.next()?"spruce":"oak";const n=new P(s*M-2.5,i*b-2.5,o);return{x:s,y:i,content:n}})),this.Qs=[new D("Heart Peak",{x:70,y:90},4,1,0),new D("Moon Plains",{x:129,y:29},8,10,20)];for(const t of v)for(let s=0;t.length-1>s;s++)this._s({x:t[s][0],y:t[s][1]},{x:t[s+1][0],y:t[s+1][1]},t[s][2]);for(const t of z)this.ti(t.x,t.y,t.r);for(const t of Object.values(A)){const{x:s,y:i,name:h}=t,e=new V(s,i,this,this.Dt,`cat ${h} altar`);s===A.kt.x&&(e.Ls=0),this.grid[i][s].content=e}for(let i=0;s>i;i++)for(let s=0;t>s;s++){const t=this.grid[i][s];t.content instanceof P&&t.content.Jt({top:this.grid[i-1]?.[s]?.content instanceof P,bottom:this.grid[i+1]?.[s]?.content instanceof P,left:this.grid[i]?.[s-1]?.content instanceof P,right:this.grid[i]?.[s+1]?.content instanceof P})}for(const t of this.Qs)t.Ms(this.Xs).forEach(t=>{this.grid[t.Et][t.Bt].content=t}),t.ys(this.Xs).forEach(t=>{this.grid[t.Et][t.Bt].content=t}),t.bs(this);S("spawn-first-spirit",()=>{this.set(64,89,new U(64,89,"🎈",this))})}Vt(){return this.grid[this.Ft.Et][this.Ft.Bt]}_s(t,s,i){const h=Math.abs(s.x-t.x),e=Math.abs(s.y-t.y),o=s.x>t.x?1:-1,n=s.y>t.y?1:-1;let r=h-e,a=t.x,c=t.y;const l=i/2;for(;;){const t=1>i?0:1.2,u=Math.ceil(this.Xs.range(-t,t)),d=Math.ceil(this.Xs.range(-t,t));for(let t=-l;l>=t;t++)for(let s=-l;l>=s;s++){const h=Math.ceil(a+t+u),e=Math.ceil(c+s+d);e>=0&&this.grid.length>e&&h>=0&&this.grid[0].length>h&&(this.grid[e][h].content=null,1>i?this.grid[e][h+1].content=null:this.Xs.next()>.1&&(this.grid[e][h].content=null))}if(a===s.x&&c===s.y)break;const f=2*r;f>-e&&(r-=e,a+=o),h>f&&(r+=h,c+=n)}}ti(t,s,i){for(let h=0;this.Nt>h;h++)for(let e=0;this.Ot>e;e++){const o=e-t,n=h-s,r=Math.sqrt(o*o+n*n),a=i+this.Xs.range(-i,i)/6;if(a>=r){const t=Math.min(1,(a-r)/2+.7);this.Xs.next()<t&&(this.grid[h][e].content=null)}}}set(t,s,i){this.grid[s]&&this.grid[s][t]&&(this.grid[s][t].content=i)}update(t){for(const s of this.grid)for(const i of s)i.content&&(i.content.update?.(t),i.x==i.content.Bt&&i.y==i.content.Et||(this.grid[i.content.Et][i.content.Bt].content=i.content,i.content=null),i.content&&i?.content?.Cs&&this.set(i.content.Bt,i.content.Et,null));this.Qs.forEach(s=>s.update(t))}draw(t,s){const i=y.zoom,h=y.rt/i/2+50,e=y.ct/i/2+50;for(const i of this.grid)for(const o of i){const i=o.x*M,n=o.y*b,r=i-t,a=n-s;r*r+a*a>5625||(o.si=!0),o.y===this.Ft.Et&&o.x===this.Ft.Bt&&o.content&&!["oak","spruce"].includes(o.content.type)&&y.wt(d.V,i-2.5,n-2.5),Math.abs(r)>h||Math.abs(a)>e||o?.content?.draw()}}}const G=(t,s,i)=>s+-(Math.cos(Math.PI*t)-1)/2*i,R={oak:a.ii,spruce:a.Mt,house:a.cs,field:a.Js,statue:a.hi,unseen:a.ei,default:a.Ys};class J{constructor(t){this.map=t,this.oi=0,this.updateInterval=100}update(t){this.oi+=t}draw(t){if(this.updateInterval>this.oi)return;this.oi=0;const s=y.ot,i=160,h=s.canvas.width-i-10,e=s.canvas.height-i-10;s.clearRect(h,e,i,i);for(let t=0;i>t;t++)for(let o=0;i>o;o++){const i=this.map.grid[t][o];s.fillStyle=i.si?R[i.content?.type||"default"]??R.default:R.unseen,s.fillRect(h+o,e+t,1,1)}t.Bt>=0&&i>t.Bt&&t.Et>=0&&i>t.Et&&(s.fillStyle=a.q,s.beginPath(),s.arc(h+t.Bt,e+t.Et,2,0,2*Math.PI),s.fill())}}class Y{constructor(){this.ni=null,S("story-dialog",t=>{this.ni=t}),S("story-state-exit",()=>{this.ni=null})}draw(){if(this.ni){const t=160,s=10,i=c3.width-t-3*s,h=s,e=c3.height-t-s;y.et.fillStyle=a.ri,y.et.fillRect(h,e,i,t),this.ni.split("\n").forEach((t,i)=>{y.ut({text:t,x:h+2*s,y:e+2*s+40*i,color:">"===t[0]?a.q:a.ai,size:5},y.et)}),y.ut({text:"press (space) to continue",x:h+i-s,y:e+t-s,color:a.q,size:5,textAlign:"right",textBaseline:"bottom"},y.et)}}}class Z{constructor(t,s,i,h){this.map=t,this.ci=s,this.actions=i,this.Dt=h,this.li=!1,this.ui=!1,this.di=!1,this.fi=new J(t),this.wi=new Y,S("enable-scratch",()=>{this.ui=!0}),S("not-enough-magic",()=>{this.di=!0})}update(t){this.fi.update(t)}draw(){this.ui&&this.pi(),this.di&&this.gi(),this.xi(),this.li&&this.yi(),this.mi(),this.Mi(),this.ui&&this.fi.draw(this.ci),this.wi.draw()}mi(){const t=this.actions.actions;if(!t.some(t=>t.enabled))return;const s=Math.round((y.et.canvas.width-(120*t.length+10*(t.length-1)))/2),i=y.et.canvas.height-120-10;t.forEach(({type:t,color:h,bi:e,enabled:o},n)=>{const r=s+130*n;y.et.fillStyle=a.ri,y.et.fillRect(r,i,120,120),o&&(y.ut({text:e,x:r+60,y:i+30,color:h,textAlign:"center",textBaseline:"middle",size:7},y.et),y.ut({text:"key: "+(n+1),x:r+60,y:i+70,color:a.ai,textAlign:"center",textBaseline:"middle",size:3},y.et),y.ut({text:t,x:r+60,y:i+95,color:a.ai,textAlign:"center",textBaseline:"middle",size:3},y.et))})}pi(){const t=Math.floor(this.Dt.ki),s=Math.floor(9-this.Dt.ki),i=9-t-s,h=this.Dt.ki-t,e="#".repeat(t)+(h>.3?"$":"%").repeat(i)+"&".repeat(s),o=5*(6*e.length+1);y.et.fillStyle=a.ri,y.et.fillRect(16,16,o,35),y.ut({text:e,x:21,y:21,color:a.q,size:5},y.et)}gi(){let t=c3.width-16;const s=this.Dt.zi,i=this.Dt.Ai-this.Dt.zi,h=5-this.Dt.Ai;y.et.fillStyle=a.Js,y.et.fillRect(t-155+5,16,155,35);let e="*".repeat(s);t-=30*e.length,y.ut({text:e,x:t+5,y:21,color:a.ks,size:5},y.et),e="*".repeat(i),t-=30*e.length,y.ut({text:e,x:t+5,y:21,color:a.Ci,size:5},y.et),e="*".repeat(h),t-=30*e.length,y.ut({text:e,x:t+5,y:21,color:a.Ys,size:5},y.et)}xi(){this.Dt.Si.filter(t=>t.time>0).forEach((t,s)=>{const{label:i,time:h}=t,e=61+70*s;let o=0;h>4800?o=-436*(1-G((5e3-h)/200,0,1)):200>h&&(o=-436*(1-G(h/200,0,1)));const n=16+o;y.et.fillStyle=a.q,y.et.fillRect(n,e,420,65),y.ut({text:"NEW GOAL",x:n+3+5,y:e+5,color:a.dt,size:4},y.et),y.ut({text:i,x:n+3+5+20,y:35+e+5,color:a.ai,size:3},y.et)})}yi(){const t=Math.round(c3.width/2-115);y.et.fillStyle=a.ri,y.et.fillRect(t,16,230,62),y.et.fillStyle=a.Zs,y.et.fillRect(t+5,21,220,25),y.et.fillStyle=this.Dt.$i>.9?a.q:a.vs,y.et.fillRect(t+5,21,3*Math.round(220*this.Dt.$i/3),25),y.ut({text:"superstition",x:c3.width/2,y:54,color:a.Zs,size:3,textAlign:"center"},y.et)}Mi(){if(!this.map.Ft)return;const t=this.map.Vt();if(t?.content?.name){const s=350,i=35;y.et.fillStyle=a.zs,y.et.fillRect(c3.width/2-s/2+4,c3.height-170-18-4,s-8,i+8),y.et.fillStyle=a.Ys,y.et.fillRect(c3.width/2-s/2,c3.height-170-18,s,i),y.ut({text:""+t.content.name,x:c3.width/2,y:c3.height-170,textAlign:"center",textBaseline:"middle",color:a.q,size:3},y.et)}}}class Q extends C{constructor(t){super(d.O,759,968,"obelisk","obelisk"),this.name="barrier obelisk",this.Us=0,this.map=t,this.map.set(this.Bt,this.Et,this)}draw(){super.draw(),this.Us>0&&N(this.Us,k,this.x,this.y,[a.Js,a.Ys,a.cs,a.Zs])}Ii(){k*(this.map.Dt.zi/5)>this.Us?this.Us++:$("not-enough-magic")}}class X{constructor(t,s){this.actions=[{type:"scratch",color:a.q,enabled:!1,bi:"\\"},{type:"teleport",color:a.vs,enabled:!1,bi:"["},{type:"restore",color:a.ii,enabled:!1,bi:"]"}],this.map=t,this.ci=s,S("enable-scratch",()=>{this.actions[0].enabled=!0})}update(){if(this.actions[2].enabled=this.Pi(),this.actions[1].enabled=this.Bi(),e.A&&!e.I.A&&$("teleport"),e.C&&!e.I.C){$("restore");const s=this.map.Vt().content;k>s.Us&&(s instanceof V?(s.Us++,k>s.Us||t(()=>{$("statue-restored")},4e3)):s instanceof Q&&s.Ii())}}Pi(){const t=this.map.Vt().content;return["statue","obelisk"].includes(t?.type??"")&&k>t.Us}Bi(){const t=this.map.Vt();return"statue"===t.content?.type&&this.ci.Bt!=A.kt.x}}class _{constructor(){this.Kt=!1,this.ki=9,this.Ai=0,this.zi=0,this.level=1,this.$i=0,this.Ei=0,this.Si=[],S("scared",()=>{this.$i=Math.min(1,this.$i+.005),this.Ei=5e3}),S("cutscene-start",()=>{this.Kt=!0}),S("cutscene-end",t=>{this.Kt=!1,t.Si&&t.Si.forEach(t=>{this.Si.push({label:t,time:5e3})})}),S("attack-player",t=>{this.ki-=(t+1)/3,this.ki=Math.round(3*this.ki)/3,this.ki=Math.round(10*this.ki)/10,this.ki>0||(this.ki=0,$("game-over"))}),S("statue-restored",()=>{this.Ai++,this.zi=this.Ai})}update(t){this.Ei-=t,this.$i>0&&0>=this.Ei&&(this.$i-=1/t*.001),this.Si.forEach(s=>s.time-=t)}}new _;class tt{constructor(t){this.Wi=t,this.ji=[],S("particle",t=>{this.Di(t.from,t.to,t.size,t.color,t.duration)})}Di(t,s,i,h,e){this.ji.push({from:t,to:s,size:i,color:h,duration:e,time:0})}update(t){this.ji.forEach(s=>{const i=((t,s=5)=>1===t?1:1-Math.pow(2,-s*t))(Math.min(1,s.time/s.duration)),h=s.from.x+(s.to.x-s.from.x)*i,e=s.from.y+(s.to.y-s.from.y)*i;this.Wi.fillStyle=s.color,this.Wi.fillRect(h,e,s.size,s.size),s.time+=t}),this.ji=this.ji.filter(t=>t.duration>t.time)}}class st{constructor(t){this.Ti=t,this.Hi=null,this.Li=0,this.isActive=!1,this.Fi=!1,this.currentState=null,this.Ki="",this.Ni=0,this.Oi=0,this.Ui=20,this.Vi="waiting",S("story-state-enter",t=>{this.qi(t)})}qi(t){this.Ti[t]&&(this.Hi=t,this.currentState=t,this.Li=0,this.isActive=!0,this.Fi=!1,this.Gi())}update(t){if(!this.isActive||!this.Hi)return;const s=e.$.get("Space"),i=s&&!this.Fi;if(this.Fi=s||!1,"typing"===this.Vi){this.Oi+=t;const s=Math.floor(this.Oi/1e3*this.Ui);this.Ki.length>s?s>this.Ni&&(this.Ni=s,this.Ri()):(this.Ni=this.Ki.length,this.Vi="complete",this.Ri())}i&&this.Ji()}Ji(){if(this.Hi){if("typing"===this.Vi)return this.Ni=this.Ki.length,this.Vi="complete",void this.Ri();"complete"===this.Vi&&(this.Ti[this.Hi].Yi.length-1>this.Li?(this.Li++,this.Gi()):this.Zi())}}Ri(){const t=this.Ki.substring(0,this.Ni);$("story-dialog",t)}Gi(){if(!this.Hi)return;const t=this.Ti[this.Hi];t.Qi=!0,this.Ki=t.Yi[this.Li],this.Ni=0,this.Oi=0,this.Vi="typing",this.Ri()}Zi(){if(!this.Hi)return;const t=this.Hi;this.isActive=!1,this.Hi=null,this.currentState=null,this.Li=0,$("story-state-exit",t)}}var it;(t=>{t[t.intro=1]="intro",t[t.spirit=2]="spirit",t[t.barrier=3]="barrier",t[t.temple=4]="temple",t[t.noMagic=5]="noMagic"})(it||(it={}));const ht={[it.intro]:{Yi:["Zzzzz...","Yawwwn...","How long was i sleeping?..."]},[it.spirit]:{Yi:["Evil spirits?","Has the magic barrier failed\nwhile I slept??","This one seems weak.","I'll exorcise it and then\ngo check the barrier","> Press (1) to attack\n> Hold (1) to charge"],Si:["find magic barrier obelisk"]},[it.barrier]:{Yi:["I have no magic power left!","Something must be wrong with\nthe cat altar."],Si:["repair the cat altar"]},[it.noMagic]:{Yi:["I don't have enough magic!","Something must be wrong with\nthe cat altars in the valley"]},[it.temple]:{Yi:["My magic has increased a little.","But the other altars...\nthey must be damaged too."],Si:["repair all 5 temples","restore the forest magic barrier"]}};class et{constructor(){this.Xi=new st(ht),S("story-state-exit",s=>{$("cutscene-end",ht[s]),s===it.intro&&($("wake-up"),$("spawn-first-spirit"),y.st=.08,t(()=>{$("story-state-enter",it.spirit)},3e3)),s===it.spirit&&$("enable-scratch")}),S("story-state-enter",()=>{$("cutscene-start")}),S("not-enough-magic",()=>{$("story-state-enter",ht[it.barrier].Qi?it.noMagic:it.barrier)}),S("statue-restored",()=>{$("story-state-enter",it.temple)}),t(()=>this.Xi.qi(it.intro),1e3)}update(t){this.Xi.update(t)}}const ot=new class{_i(){this.ji=new tt(y.ht),this.Dt=new _,this.map=new q(160,160,this.Dt),this.N=new I(60,85,this.map,this.Dt),this.actions=new X(this.map,this.N),this.th=new Z(this.map,this.N,this.actions,this.Dt),this.Xi=new et,this.map.set(this.N.Bt,this.N.Et,this.N),new Q(this.map),y.gt(this.N.x,this.N.y,20,!0),y.st=.01}sh(t){y.gt(this.N.x,this.N.y,7-this.Dt.ki+7),y.xt(),!this.Dt.Kt&&this.Dt.ki>0?(this.actions.update(),this.map.update(t),this.th.update(t),this.ji.update(t),this.Dt.update(t)):this.Dt.Kt&&this.N.update(t),this.Xi.update(t),s(t),0==this.Dt.ki?this.N.draw():(this.map.draw(this.N.x,this.N.y),this.th.draw()),y.yt()}},nt=new class{constructor(){this.ih=!0}sh(){const t=y.ht.canvas.width/2;y.ut({text:"Whiskers Valley",x:t,y:100,color:a.cs,size:4,textAlign:"center"}),y.ut({text:"Start Game",x:t,y:200,color:this.ih?a.dt:a.cs,size:3,textAlign:"center"}),y.ut({text:"Toggle Fullscreen",x:t,y:250,color:this.ih?a.cs:a.dt,size:3,textAlign:"center"}),this.hh()}hh(){(e.l&&!e.I.l||e.u&&!e.I.u)&&(this.ih=!this.ih),e.M&&!e.I.M&&(this.ih?h.eh(ot):document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen())}};document.querySelector('link[type="image/x-icon"]').href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='85'%3E💜%3C/text%3E%3C/svg%3E";let rt=0,at=[],ct=!1;window.addEventListener("blur",()=>{ct=!0}),window.addEventListener("focus",()=>{ct=!1}),h=new class{constructor(t,...s){this.currentState=t,this.currentState._i?.(...s)}eh(t,...s){this.currentState.oh?.(),this.currentState=t,this.currentState._i?.(...s)}getState(){return this.currentState}}(nt,...[]),setInterval(t=>{if(ct)return;let i=(t=performance.now())-rt;if(rt=t,i>1e3)return;at.push(1e3/i),15===at.length&&(fps.innerHTML=Math.round(at.reduce((t,s)=>t+s)/15)+" FPS",at=[]),y.clear();const o=h.getState();e.W(),o.sh(i),s(i)},16);